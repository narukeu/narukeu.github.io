import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.lo-SgHyK.js";const c=JSON.parse('{"title":"PRD 文档","description":"","frontmatter":{},"headers":[],"relativePath":"design-doc/packer.md","filePath":"design-doc/packer.md","lastUpdated":1765375470000}'),h={name:"design-doc/packer.md"};function e(t,s,p,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="prd-文档" tabindex="-1">PRD 文档 <a class="header-anchor" href="#prd-文档" aria-label="Permalink to “PRD 文档”">​</a></h1><h2 id="_1-前言" tabindex="-1">1. 前言 <a class="header-anchor" href="#_1-前言" aria-label="Permalink to “1. 前言”">​</a></h2><p>一个个人项目，做一个类似 WebPack 风格的打包工具。比较喜欢 Webpack 的设计，但是 Webpack 历史包袱太重了，就打算抱着试一试的心态做一个所谓的「现代化 Webpack」。</p><h2 id="_2-设计目标" tabindex="-1">2. 设计目标 <a class="header-anchor" href="#_2-设计目标" aria-label="Permalink to “2. 设计目标”">​</a></h2><h3 id="_2-1-前端优先" tabindex="-1">2.1 前端优先 <a class="header-anchor" href="#_2-1-前端优先" aria-label="Permalink to “2.1 前端优先”">​</a></h3><p>现在 Node.js 生态中，ESM 已经成为未来的，对于后端和许多工具库场景，打包的必要性在下降，越来越多项目选择直接以源码形式、或者简单经过 TSC 编译后就发布。</p><p>所以 Packer 关注于前端的应用打包，以及前端相关的库打包。</p><h3 id="_2-2-框架无关" tabindex="-1">2.2 框架无关 <a class="header-anchor" href="#_2-2-框架无关" aria-label="Permalink to “2.2 框架无关”">​</a></h3><p>从框架本身来说，Packer 可以用于多种前端框架，而不仅仅局限于某一种框架。</p><p>但从项目初期开发目标来看，优先支持 React 生态。</p><h3 id="_2-3-unplugin-生态兼容" tabindex="-1">2.3 Unplugin 生态兼容 <a class="header-anchor" href="#_2-3-unplugin-生态兼容" aria-label="Permalink to “2.3 Unplugin 生态兼容”">​</a></h3><p>Packer 既然是一个独立于 Vite 和 Webpack 的打包器，那么不会去直接做与 Vite、Webpack 的兼容，这个没有意义，但为了复用现有的生态，Packer 会兼容 Unplugin 生态。</p><h3 id="_2-4-现代化" tabindex="-1">2.4 现代化 <a class="header-anchor" href="#_2-4-现代化" aria-label="Permalink to “2.4 现代化”">​</a></h3><p>Packer 目前来说是一个个人项目，没有商业化和大规模兼容性的需求，因此在设计上会进行一些激进的取舍。</p><ul><li>仅面向现代化的运行环境和工具链：运行环境假定为 Node.js 22+</li><li>只关心 ESM，不兜底 CJS 互操作：不提供 CommonJS 输出。对于必须依赖 CJS 的场景，交由 Node.js 22+ 的原生互操作能力自行解决，或者由上层应用显式处理。</li><li>不兼容现有生态：不支持 Webpack、Vite 等，仅支持 Unplugin。</li><li>Node.js 22.18 之后已经原生支持 TypeScript 可擦除语法的直接运行，因此配置文件也可以直接使用 TypeScript 编写，然后通过 Node.js 直接运行。 在个人项目的前提下，尽可能简化实现与心智负担，把精力集中在「现代前端开发体验」本身，而不是解决历史技术债。</li></ul><h2 id="_3-预期的项目结构" tabindex="-1">3. 预期的项目结构 <a class="header-anchor" href="#_3-预期的项目结构" aria-label="Permalink to “3. 预期的项目结构”">​</a></h2><ul><li>packages <ul><li>core</li><li>cli</li><li>config</li><li>dev-server</li><li>plugins（但 plugins 目录本身不是一个包） <ul><li>plugin-css</li></ul></li><li>loaders（但 loaders 目录本身不是一个包） <ul><li>loader-swc</li><li>loader-babel</li></ul></li></ul></li></ul><h2 id="_3-配置文件和核心功能" tabindex="-1">3. 配置文件和核心功能 <a class="header-anchor" href="#_3-配置文件和核心功能" aria-label="Permalink to “3. 配置文件和核心功能”">​</a></h2><p>我们可以从配置文件入手。</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SupportFormat</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;esm&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;iife&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  entry</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  output</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    dir</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    format</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SupportFormat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LoaderOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  test</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  exclude</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PluginOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  options</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServerOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  port</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  host</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 静态资源目录，默认 public</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AssetsOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  inlineLimit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 资源内联限制，单位字节，默认 8192</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  types</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 支持的资源类型，会写在常量里面</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BuildOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  sourcemap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PackerConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> BaseOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  loaders</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> LoaderOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  plugins</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PluginOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[];</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  devServer</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ServerOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  assets</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> AssetsOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-1-入口和出口" tabindex="-1">3.1 入口和出口 <a class="header-anchor" href="#_3-1-入口和出口" aria-label="Permalink to “3.1 入口和出口”">​</a></h3><h3 id="_3-2-loaders" tabindex="-1">3.2 Loaders <a class="header-anchor" href="#_3-2-loaders" aria-label="Permalink to “3.2 Loaders”">​</a></h3><p>这里的 Loader 类似 Webpack 的 Loader，负责对特定类型的文件进行处理。每个 Loader 通过 <code>test</code> 字段来匹配文件类型。与 Webpack 不同的是，这里的 test 仅支持 glob 模式的字符串匹配。</p><p>Webpack 需要 <code>asset/resource</code> 来处理静态资源文件，但 Packer 这里并不需要，除非需要自定义逻辑，否则内置的静态资源处理已经足够。</p><h3 id="_3-3-plugins" tabindex="-1">3.3 Plugins <a class="header-anchor" href="#_3-3-plugins" aria-label="Permalink to “3.3 Plugins”">​</a></h3><h3 id="_3-4-开发服务器" tabindex="-1">3.4 开发服务器 <a class="header-anchor" href="#_3-4-开发服务器" aria-label="Permalink to “3.4 开发服务器”">​</a></h3><p>基于 <code>h3js/h3</code> 这一轻量级的 HTTP 框架，Packer 内置了一个开发服务器，支持热更新和静态资源服务。</p><p>开发服务器采用<strong>全量打包</strong>模式，而不是 Vite 中通过 Esbuild 实现的按需编译，为什么这么做？</p><ul><li>现在基于原生的转译工具速度已经非常快，全量打包的时间开销已经可以接受。</li><li>全量打包可以更好地模拟生产环境，减少开发和生产环境的差异。</li><li>Vite 的按需编译在大型项目中可能会导致性能瓶颈，尤其是在复杂依赖关系的情况下。</li><li>Vite Rolldown 新版也已经明确表示将会用回全量打包模式<a href="https://vite.dev/guide/rolldown#future-plans" target="_blank" rel="noreferrer">^1</a>。</li></ul><h4 id="_3-4-2" tabindex="-1">3.4.2 <a class="header-anchor" href="#_3-4-2" aria-label="Permalink to “3.4.2”">​</a></h4><h2 id="_4-核心概念" tabindex="-1">4. 核心概念 <a class="header-anchor" href="#_4-核心概念" aria-label="Permalink to “4. 核心概念”">​</a></h2><h3 id="_4-1-compiler-和-compilation" tabindex="-1">4.1 Compiler 和 Compilation <a class="header-anchor" href="#_4-1-compiler-和-compilation" aria-label="Permalink to “4.1 Compiler 和 Compilation”">​</a></h3><p>Webpack 的 Compiler 和 Compilation 仍然是一个不错的设计，但是需要在此基础上进行简化和现代化。</p><h2 id="_5-官方插件" tabindex="-1">5. 官方插件 <a class="header-anchor" href="#_5-官方插件" aria-label="Permalink to “5. 官方插件”">​</a></h2><h3 id="_5-1-packer-swc-loader" tabindex="-1">5.1 <code>@packer/swc-loader</code> <a class="header-anchor" href="#_5-1-packer-swc-loader" aria-label="Permalink to “5.1 @packer/swc-loader”">​</a></h3><p>作为默认的 JS/TS Loader，基于 SWC 实现。因为 Packer 目前目标是完成 React 的打包，又需要性能，因此结合 swc-loader 进行。</p><h2 id="_6-依赖" tabindex="-1">6. 依赖 <a class="header-anchor" href="#_6-依赖" aria-label="Permalink to “6. 依赖”">​</a></h2><h3 id="_6-1-核心依赖" tabindex="-1">6.1 核心依赖 <a class="header-anchor" href="#_6-1-核心依赖" aria-label="Permalink to “6.1 核心依赖”">​</a></h3><table tabindex="0"><thead><tr><th>软件包</th><th>仓库地址</th><th>作用</th></tr></thead><tbody><tr><td>Consola</td><td></td><td>日志</td></tr><tr><td>h3</td><td></td><td>轻量 HTTP 服务器</td></tr><tr><td>parse5</td><td></td><td>提供 HTTP 解析能力</td></tr></tbody></table><h3 id="_5-2-swc-loader-依赖" tabindex="-1">5.2 SWC Loader 依赖 <a class="header-anchor" href="#_5-2-swc-loader-依赖" aria-label="Permalink to “5.2 SWC Loader 依赖”">​</a></h3>`,40)])])}const o=i(h,[["render",e]]);export{c as __pageData,o as default};
